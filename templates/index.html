<!DOCTYPE html>
<html lang="ko" id="no-fouc">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><!-- 호환성 -->
    <meta name="format-detection" content="telephone=no,email=no,address=no"><!-- 전화번호, 주소, 메일 등 링크로 인식방지 -->
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1"><!-- 화면맞춤 -->
    <title>AI 사업계획서 작성 시스템</title>
    <link rel="shortcut icon" type="image/x-icon" href="/static/images/favicon.ico" /><!-- 파비콘 -->

    <!-- CSS -->
    <link type="text/css" rel="stylesheet" href="/static/css/html5_reset.css" />
    <link type="text/css" rel="stylesheet" href="/static/css/fs_component.css" />
    <link type="text/css" rel="stylesheet" href="/static/css/fs_layout.css" />
    <link type="text/css" rel="stylesheet" href="/static/css/fs_main.css" />

    <!-- PDF.js 및 Sortable.js 라이브러리 추가 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <style>
        /* 레이아웃 및 스타일 */
        .container {
            display: flex;
            height: 80vh;
            background: url("/static/images/background_main.jpg") no-repeat center center fixed;
            background-size: cover;
            padding: 40px;
        }
        .left, .right {
            width: 50%;
            padding: 20px;
            box-sizing: border-box;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            overflow: hidden;
            overflow-y: auto;
        }
        .left {
            border-right: 1px solid #000;
            overflow-y: auto;
            position: relative;
        }
        .section {
            margin-bottom: 20px;
        }
        .section button {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            font-size: 1em;
            text-align: left;
            color: black;
            text-decoration: underline;
        }
        .section button:disabled {
            color: grey;
            cursor: not-allowed;
            text-decoration: none;
        }
        .section .image-label {
            display: block;
            margin-top: 10px;
            font-weight: normal;
        }
        .section .image-label input[type="file"] {
            display: inline-block;
            margin-left: 10px;
        }
        textarea {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
            resize: vertical;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
            box-sizing: border-box;
            white-space: normal;
        }
        .submit-button {
            text-align: right;
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;  /* 버튼 사이 간격 */
        }

        .submit-button .btn_bace.big {
            padding: 10px 20px;  /* 좌우 패딩 축소 */
            min-width: 120px;    /* 최소 너비 설정 */
            white-space: nowrap; /* 텍스트 줄바꿈 방지 */
            flex-shrink: 0;      /* 버튼 크기 축소 방지 */
        }
        
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: Arial, sans-serif;
        }
        /* 로딩 화면 스타일 */
        #loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255,255,255,0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #ccc;
            border-top-color: #333;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        .loading-text {
            font-size: 24px;
            color: #333;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* 캔버스 스타일 */
        .pdf-page {
            margin-bottom: 20px;
        }
        .pdf-page canvas {
            width: 100%;
            height: auto;
            display: block;
            border: 1px solid black;
            border-radius: 5px;
        }
        /* 헤더 스타일 */
        header#fs_header {
            background-color: rgba(255, 255, 255, 0.9);
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
        }
        header#fs_header .fs_head.wrap {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        header#fs_header .logo img {
            height: 50px;
        }
        header#fs_header .login_box {
            display: flex;
            align-items: center;
        }
        header#fs_header .login_box .info_popup a.btn_popup {
            margin-right: 15px;
        }
        /* 배경 이미지 추가 */
        .bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url("/static/images/background_main.jpg") no-repeat center center;
            background-size: cover;
            opacity: 0.1;
            z-index: -1;
        }
        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: auto;
            }
            .left, .right {
                width: 100%;
                margin-bottom: 20px;
            }
            header#fs_header .fs_head.wrap {
                flex-direction: column;
                align-items: flex-start;
            }
            header#fs_header .login_box {
                margin-top: 10px;
            }
        }

        /* 팝업 창 스타일 */
        .template-popup {
            display: none; /* 기본적으로 숨김 */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5); /* 반투명 배경 */
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        
        .popup-content {
            background-color: #fff; /* 흰색 배경 */
            padding: 30px; /* 패딩 증가 */
            border-radius: 10px; /* 둥근 모서리 */
            max-width: 95%; /* 최대 너비 증가 */
            max-height: 95%; /* 최대 높이 증가 */
            overflow-y: auto;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center; /* 수평 중앙 정렬 */
        }
        
        /* 닫기 버튼 */
        .btn_close {
            position: absolute;
            top: 10px;
            right: 10px;
        }
        
        /* 팝업 제목 */
        .popup-title {
            font-size: 1.5em; /* 글자 크기 감소 */
            margin-bottom: 30px; /* 아래 여백 증가 */
            text-align: center; /* 중앙 정렬 */
        }
        
        /* 이미지 컨테이너 */
        .template-images {
            display: flex;
            flex-wrap: wrap;
            gap: 20px; /* 간격 증가 */
            justify-content: center; /* 이미지들을 중앙에 정렬 */
            margin-bottom: 30px; /* 아래 여백 증가 */
        }
        
        /* 개별 이미지 박스 */
        .template-image-container {
            width: 500px; /* 너비 증가 */
            height: 500px; /* 높이 증가 */
            position: relative;
            cursor: pointer;
            display: flex;
            align-items: center; /* 이미지 수직 중앙 정렬 */
            justify-content: center; /* 이미지 수평 중앙 정렬 */
            border: 2px solid transparent;
            border-radius: 5px;
        }
        
        /* 이미지 스타일 */
        .template-image-container img {
            max-width: 100%;
            max-height: 100%;
            display: block;
        }
        
        /* 선택된 이미지 테두리 색상 */
        .template-image-container.selected {
            border-color: #28a745; /* 녹색 테두리 */
        }
        
        /* 선택 표시 원 */
        .selection-mark {
            position: absolute;
            bottom: 15px; /* 위치 조정 */
            left: 50%;
            transform: translateX(-50%);
            width: 25px; /* 크기 증가 */
            height: 25px;
            border: 2px solid #28a745;
            border-radius: 50%;
            background-color: transparent;
        }
        
        .template-image-container.selected .selection-mark {
            background-color: #28a745; /* 선택 시 원 내부 색상 */
        }
        
        /* 팝업 푸터 */
        .popup-footer {
            text-align: center; /* 중앙 정렬 */
            width: 100%;
        }
        
        /* 선택 버튼 스타일 */
        .select-button {
            padding: 15px 30px; /* 패딩 유지 */
            font-size: 1em; /* 글자 크기 감소 */
            background-color: #28a745; /* 녹색 배경 */
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .select-button:hover {
            background-color: #218838;
        }
        .table-sections {
            margin: 20px 0;
        }
        
        .table-section {
            margin-bottom: 30px;
        }
        
        .table-section h3 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #333;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        .data-table th,
        .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        .data-table th {
            background-color: #f5f5f5;
        }
        
        .data-table input[type="text"] {
            width: 100%;
            padding: 5px;
            border: none;
            background: transparent;
        }
        
        .data-table tr:hover {
            background-color: #f9f9f9;
        }
        
        .tam-content {
            font-size: 14px;
            line-height: 1.6;
            color: #333;
        }
        
        .tam-text {
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        /* 버튼 간격 조정 */
        .submit-button button {
            margin-left: 10px;
        }
        .submit-button button:first-child {
            margin-left: 0;
        }
    </style>

    <!-- JavaScript -->
    <script type="text/javascript" src="/static/js/jquery-1.12.4.min.js"></script>
    <script type="text/javascript" src="/static/js/jquery.easing.min.1.4.1.js"></script>
    <script type="text/javascript" src="/static/js/fs_common.js"></script>

    <script>
        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
        }

        // 팝업 열기
        function openPopup() {
            document.getElementById('pop_info').style.display = 'flex';
        }

        // 팝업 닫기
        function closePopup() {
            document.getElementById('pop_info').style.display = 'none';
        }

        document.addEventListener("DOMContentLoaded", function() {
            // 도움말 버튼 클릭 시 팝업 열기
            var helpButton = document.querySelector('.btn_popup');
            if (helpButton) {
                helpButton.addEventListener("click", function(event) {
                    event.preventDefault();
                    openPopup();
                });
            }
        });
    </script>
</head>
<body>
    <!-- 헤더 -->
    <header id="fs_header">
        <div class="fs_head wrap">
            <!-- 로고 -->
            <h1 class="logo"><a href="/"><img src="/static/images/layout/logo-c.png" alt="data linker"></a></h1>
            <!-- //로고 -->
            <div class="login_box">
                <div class="info_popup">
                    <a href="#none" class="btn_popup">도움말</a>
                </div>
            </div>
        </div>
    </header>
    <!-- //헤더 -->

    <!-- 메인 콘텐츠 -->
    <div id="fs_container_wrap">
        <!-- 서브 콘텐츠 -->
        <section class="fs_sub_contents">
            <!-- 메인 컨텐츠 -->
            <div class="fs_content" id="fs_content">
                <div class="bg"></div>
                <!-- 컨텐츠 바디 -->
                <div class="con_body">
                    <div class="solution_box wrap">
                        <h2 class="con_tit">AI 사업계획서 작성 시스템</h2>
                        <form method="post" action="/" enctype="multipart/form-data" onsubmit="showLoading()">
                            <div class="container">
                                <div class="left" id="pdf-container">
                                    <!-- PDF 페이지들이 렌더링될 영역 -->
                                </div>
                                <div class="right">
                                    <input type="hidden" name="section_order" id="section-order">
                                    <div id="sections-container">
                                        {% for tag in combined_tags %}
                                            {% if not tag.startswith('T') %}
                                                <div class="section draggable" data-id="{{ tag }}">
                                                    {% set section_number = tag.split('-')[0].replace('SECTION', '')|int %}
                                                    <button type="button" class="section-handle" onclick="goToPage('{{ tag }}')" id="btn-section-{{ tag|lower }}" disabled>
                                                        섹션 {{ tag }}:
                                                    </button>
                                                    {% if tag in template_tags %}
                                                    <!-- 템플릿 제목 입력 섹션 -->
                                                    <div class="template-selection">
                                                        <textarea name="{{ tag }}" placeholder="관련 텍스트를 입력 및 수정해주세요.">{% if generated_sections.get(tag) %}{{ generated_sections[tag].text.strip() }}{% endif %}</textarea>
                                                        <button type="button" class="template-button" onclick="openTemplatePopup('{{ tag }}')">템플릿 선택</button>
                                                        <div id="selected-image-{{ tag }}"></div>
                                                        <input type="hidden" name="{{ tag }}_selected_image" id="{{ tag }}_selected_image">
                                                    </div>
                                                    
                                                    {% elif tag in text_tags %}
                                                    <!-- 관련 텍스트 입력 및 수정 섹션 -->
                                                    <textarea name="{{ tag }}" placeholder="관련 텍스트를 입력 및 수정해주세요.">{% if generated_sections.get(tag) %}{{ generated_sections[tag].text.strip() }}{% endif %}</textarea>
                                                    
                                                    {% elif tag in image_tags %}
                                                    <!-- 이미지 업로드 및 제목 입력 섹션 -->
                                                    <textarea name="{{ tag }}" placeholder="관련 텍스트를 입력 및 수정해주세요.">{% if generated_sections.get(tag) %}{{ generated_sections[tag].text.strip() }}{% endif %}</textarea>
                                                    <div class="image-label">
                                                        이미지 업로드(선택):
                                                        <input type="file" name="{{ tag }}_image" accept="image/*">
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div> 
                                    <div class="table-sections">
                                        <!-- 첫 번째 표 (T1-T48) -->
                                        <div class="table-section">
                                            <h3>사업추진 일정(전체 사업단계)</h3>
                                            <table class="data-table">
                                                <thead>
                                                    <tr>
                                                        <th>순번</th>
                                                        <th>추진내용</th>
                                                        <th>추진 기간</th>
                                                        <th>세부 내용</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for i in range(1, 33, 4) %}
                                                    <tr>
                                                        <td><input type="text" name="T{{i}}" value="{{ generated_sections.get('T' ~ i, {'text': ''}).text }}"></td>
                                                        <td><input type="text" name="T{{i+1}}" value="{{ generated_sections.get('T' ~ (i+1), {'text': ''}).text }}"></td>
                                                        <td><input type="text" name="T{{i+2}}" value="{{ generated_sections.get('T' ~ (i+2), {'text': ''}).text }}"></td>
                                                        <td><input type="text" name="T{{i+3}}" value="{{ generated_sections.get('T' ~ (i+3), {'text': ''}).text }}"></td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                     
                                        <!-- 두 번째 표 (T101-T148) -->
                                        <div class="table-section">
                                            <h3>사업추진일정(협약기간 내)</h3>
                                            <table class="data-table">
                                                <thead>
                                                    <tr>
                                                        <th>순번</th>
                                                        <th>추진내용</th>
                                                        <th>추진 기간</th>
                                                        <th>세부 내용</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for i in range(101, 133, 4) %}
                                                    <tr>
                                                        <td><input type="text" name="T{{i}}" value="{{ generated_sections.get('T' ~ i, {'text': ''}).text }}"></td>
                                                        <td><input type="text" name="T{{i+1}}" value="{{ generated_sections.get('T' ~ (i+1), {'text': ''}).text }}"></td>
                                                        <td><input type="text" name="T{{i+2}}" value="{{ generated_sections.get('T' ~ (i+2), {'text': ''}).text }}"></td>
                                                        <td><input type="text" name="T{{i+3}}" value="{{ generated_sections.get('T' ~ (i+3), {'text': ''}).text }}"></td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                     
                                        <!-- 세 번째 표 (T201-T227) -->
                                        <div class="table-section">
                                            <h3>정부지원사업비 집행계획</h3>
                                            <table class="data-table">
                                                <thead>
                                                    <tr>
                                                        <th>비목</th>
                                                        <th>산출근거</th>
                                                        <th>정부지원사업비(원)</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for i in range(201, 225, 3) %}
                                                    <tr>
                                                        <td><input type="text" name="T{{i}}" value="{{ generated_sections.get('T' ~ i, {'text': ''}).text }}"></td>
                                                        <td><input type="text" name="T{{i+1}}" value="{{ generated_sections.get('T' ~ (i+1), {'text': ''}).text }}"></td>
                                                        <td><input type="text" name="T{{i+2}}" value="{{ generated_sections.get('T' ~ (i+2), {'text': ''}).text }}"></td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                     
                                        <!-- 네 번째 표 (T301-T348) -->
                                        <div class="table-section">
                                            <h3>자금 필요성 및 조달계획</h3>
                                            <table class="data-table">
                                                <thead>
                                                    <tr>
                                                        <th>순번</th>
                                                        <th>추진내용</th>
                                                        <th>추진 기간</th>
                                                        <th>세부 내용</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for i in range(301, 333, 4) %}
                                                    <tr>
                                                        <td><input type="text" name="T{{i}}" value="{{ generated_sections.get('T' ~ i, {'text': ''}).text }}"></td>
                                                        <td><input type="text" name="T{{i+1}}" value="{{ generated_sections.get('T' ~ (i+1), {'text': ''}).text }}"></td>
                                                        <td><input type="text" name="T{{i+2}}" value="{{ generated_sections.get('T' ~ (i+2), {'text': ''}).text }}"></td>
                                                        <td><input type="text" name="T{{i+3}}" value="{{ generated_sections.get('T' ~ (i+3), {'text': ''}).text }}"></td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>                                                                                                       
                                    <!-- 제출 버튼 -->
                                    <div class="submit-button">
                                        <button type="button" class="btn_bace big" onclick="openTAMPopup()">추가 정보 제공</button>
                                        <button type="button" class="btn_bace big" onclick="openLayoutPopup()">레이아웃 선택</button>
                                        <button type="submit" class="btn_bace big">사업계획서 생성</button>
                                    </div>
                                </div>    
                            </div>
                        </form>
                    </div>
                    <!-- //컨텐츠 바디 -->
                </div>
            </div>
            <!-- //메인 컨텐츠 -->
        </section>
        <!-- //서브 콘텐츠 -->
    </div>
    <!-- //메인 콘텐츠 -->

    <!-- 로딩 화면 -->
    <div id="loading">
        <div class="spinner"></div>
        <div class="loading-text">사업계획서 생성 중입니다...</div>
    </div>

    <!-- 팝업 도움말 -->
    <div id="pop_info" class="pop_info">
        <div class="pop_cont">
            <button type="button" class="btn_close" onclick="closePopup()">X</button>
            <div class="pop_tit">도움말</div>
            <div class="txtbox">
                <p>
                    서비스에 대한 도움말 내용을 여기에 추가하세요.
                </p>
            </div>
        </div>
    </div>

    <!-- 팝업 창 추가 -->
    <div id="template-popup" class="template-popup">
        <div class="popup-content">
            <button type="button" class="btn_close" onclick="closeTemplatePopup()">X</button>
            <div class="popup-title">템플릿 선택</div>
            <div id="template-images" class="template-images">
                <!-- 이미지들이 동적으로 로드됩니다 -->
            </div>
            <!-- 선택 버튼 추가 -->
            <div class="popup-footer">
                <button type="button" class="select-button" onclick="confirmSelection()">선택</button>
            </div>
        </div>
    </div>

    <!-- 레이아웃 선택 결과를 담을 hidden input -->
    <input type="hidden" name="selected_layout" id="selected-layout">

    <!-- 레이아웃 선택 팝업 -->
    <div id="layout-popup" class="template-popup">
        <div class="popup-content">
            <button type="button" class="btn_close" onclick="closeLayoutPopup()">X</button>
            <div class="popup-title">레이아웃 선택</div>
            <div id="layout-options" class="template-images">
                <!-- 여기에 레이아웃 PDF 선택지가 들어갈 예정 -->
            </div>
            <div class="popup-footer">
                <button type="button" class="select-button" onclick="confirmLayoutSelection()">선택</button>
            </div>
        </div>
    </div>

    <!-- TAM 정보 팝업 추가 -->
    <div id="tam-popup" class="template-popup">
        <div class="popup-content">
            <button type="button" class="btn_close" onclick="closeTAMPopup()">X</button>
            <div class="popup-title">시장 분석 정보</div>
            <div class="tam-content" style="max-height: 70vh; overflow-y: auto; padding: 20px;">
                <!-- TAM 데이터가 여기에 표시됩니다 -->
            </div>
        </div>
    </div>

    <!-- PDF.js를 사용한 스크립트 -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {

            // 섹션 번호별 페이지 매핑 객체 추가
            const sectionBasePageMapping = {
                'SECTION1': 3,  // SECTION1로 시작하는 모든 섹션은 3페이지
                'SECTION2': 4,  
                'SECTION3': 7,  
                'SECTION4': 9,  
                'SECTION5': 11,  
                'SECTION6': 13,  
                'SECTION8': 14,  
                'SECTION9': 16,  
                'SECTION10': 18,  
                'SECTION11': 22,  
                // 필요한 섹션 베이스와 시작 페이지 번호를 추가하세요
            };

            var url = "/static/uploads/{{ pdf_file }}"; // PDF 파일 경로

            var pdfjsLib = window['pdfjs-dist/build/pdf'];
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';

            var pdfDoc = null,
                scale = 1.5, // 스케일 조정
                container = document.getElementById('pdf-container');

            // 드래그 앤 드롭 기능 추가
            var sectionsContainer = document.getElementById('sections-container');
            var sectionOrderInput = document.getElementById('section-order');

            // Sortable 인스턴스 생성
            var sortable = Sortable.create(sectionsContainer, {
                animation: 150,
                handle: '.section-handle',
                onEnd: function (evt) {
                    updateSectionOrder();
                }
            });

            // 섹션 순서를 업데이트하는 함수
            function updateSectionOrder() {
                var sectionIds = [];
                var sections = sectionsContainer.querySelectorAll('.section');
                sections.forEach(function(section) {
                    sectionIds.push(section.getAttribute('data-id'));
                });
                // 표 태그들도 section_order에 포함
                var tableInputs = document.querySelectorAll('input[name^="T"]');
                tableInputs.forEach(function(input) {
                    sectionIds.push(input.name);
                });
                // 섹션 순서를 숨겨진 인풋 필드에 설정
                sectionOrderInput.value = sectionIds.join(',');
            }

            // 페이지 로드 시 섹션 순서 초기화
            updateSectionOrder();

            // PDF를 렌더링하는 함수 (순차적 렌더링을 위해 Promise 반환)
            function renderPage(num) {
                return pdfDoc.getPage(num).then(function(page) {
                    var viewport = page.getViewport({ scale: scale });
                    var pageContainer = document.createElement('div');
                    pageContainer.className = 'pdf-page';
                    pageContainer.id = 'page-' + num;

                    var canvas = document.createElement('canvas');
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    var ctx = canvas.getContext('2d');

                    var renderContext = {
                        canvasContext: ctx,
                        viewport: viewport
                    };
                    var renderTask = page.render(renderContext);

                    return renderTask.promise.then(function() {
                        pageContainer.appendChild(canvas);
                        container.appendChild(pageContainer);
                    });
                });
            }

            // 모든 페이지를 순차적으로 렌더링
            function renderAllPages() {
                // 기존 페이지 삭제
                var existingPages = container.querySelectorAll('.pdf-page');
                existingPages.forEach(function(page) {
                    container.removeChild(page);
                });

                // 순차적 렌더링을 위한 Promise 체인 생성
                var renderChain = Promise.resolve();
                for (var num = 1; num <= pdfDoc.numPages; num++) {
                    (function(pageNum) {
                        renderChain = renderChain.then(function() {
                            return renderPage(pageNum);
                        });
                    })(num);
                }

                // 모든 페이지 렌더링 완료 후 버튼 활성화
                renderChain.then(function() {
                    enableSectionButtons();
                }).catch(function(error) {
                    console.error('페이지 렌더링 중 오류 발생:', error);
                });
            }

            // PDF 문서 로드 및 렌더링 시작
            pdfjsLib.getDocument(url).promise.then(function(pdfDoc_) {
                pdfDoc = pdfDoc_;
                renderAllPages();
            }).catch(function(error) {
                console.error('PDF 로드 중 오류 발생:', error);
            });

            function enableSectionButtons() {
                console.log("섹션 버튼 활성화.");
                var sectionTags = {{ combined_tags | tojson }};
                sectionTags.forEach(function(tag) {
                    var btnId = 'btn-section-' + tag.toLowerCase();
                    var btn = document.getElementById(btnId);
                    if (btn) {
                        btn.disabled = false;
                        // onclick 이벤트 수정
                        btn.onclick = function() {
                            goToPage(tag);
                        };
                    }
                });
            }
            
            // 페이지 이동 함수 수정
            function goToPage(sectionTag) {
                console.log("goToPage 호출됨. 섹션:", sectionTag);

                if (pdfDoc === null) {
                    console.log("PDF 문서가 아직 로드되지 않았습니다.");
                    return;
                }

                // 섹션 태그에서 기본 섹션 부분 추출 (예: "SECTION1-A" -> "SECTION1")
                const baseSection = sectionTag.split('-')[0];
                
                // 해당 섹션의 기본 페이지 번호 가져오기
                const pageNum = sectionBasePageMapping[baseSection];
                
                if (pageNum && pageNum <= pdfDoc.numPages) {
                    var pageElement = document.getElementById('page-' + pageNum);
                    if (pageElement) {
                        pageElement.scrollIntoView({ behavior: 'smooth' });
                    }
                } else {
                    console.log("해당 섹션의 페이지를 찾을 수 없습니다:", sectionTag);
                }
            }

            // 글로벌 함수로 설정
            window.goToPage = goToPage;
        });

        // 선택된 이미지 경로를 저장할 변수
        var selectedImagePath = '';

        // 함수 정의 및 전역 범위로 설정
        function openTemplatePopup(tag) {
            // 팝업 창 열기
            var popup = document.getElementById('template-popup');
            popup.style.display = 'flex';

            // 현재 태그를 저장하여 선택 시 참조
            popup.setAttribute('data-tag', tag);

            // 이미지 컨테이너 가져오기
            var imageContainer = document.getElementById('template-images');
            imageContainer.innerHTML = ''; // 기존 내용 초기화

            // 서버로부터 이미지 목록 가져오기
            fetch(`/get_template_images?folder=image_templates/${tag}`)
                .then(response => response.json())
                .then(data => {
                    var images = data.images;

                    images.forEach(function(imagePath) {
                        var container = document.createElement('div');
                        container.className = 'template-image-container';

                        var img = document.createElement('img');
                        img.src = imagePath;
                        img.onclick = function() {
                            selectImage(imagePath, container);
                        };

                        var mark = document.createElement('div');
                        mark.className = 'selection-mark';

                        container.appendChild(img);
                        container.appendChild(mark);
                        imageContainer.appendChild(container);
                    });
                })
                .catch(error => console.error('이미지 목록을 가져오는 중 오류 발생:', error));
        }
        window.openTemplatePopup = openTemplatePopup; // 전역 범위로 설정

        function selectImage(imagePath, container) {
            // 기존에 선택된 이미지 스타일 초기화
            var containers = document.querySelectorAll('.template-image-container');
            containers.forEach(function(c) {
                c.classList.remove('selected');
            });

            // 선택된 이미지 스타일 적용
            container.classList.add('selected');

            // 선택된 이미지 경로 저장
            selectedImagePath = imagePath;
        }
        window.selectImage = selectImage; // 전역 범위로 설정

        function confirmSelection() {
            if (selectedImagePath === '') {
                alert('이미지를 선택해주세요.');
                return;
            }

            // 팝업에서 저장한 태그를 가져옴
            var popup = document.getElementById('template-popup');
            var tag = popup.getAttribute('data-tag');

            // 선택된 이미지 표시
            var selectedImageDiv = document.getElementById('selected-image-' + tag);
            selectedImageDiv.innerHTML = '<img src="' + selectedImagePath + '" class="selected-template-image">';

            // 선택된 이미지 경로를 hidden input에 저장
            var hiddenInput = document.getElementById(tag + '_selected_image');
            hiddenInput.value = selectedImagePath;

            // 팝업 닫기
            closeTemplatePopup();

            // 선택된 이미지 경로 초기화
            selectedImagePath = '';
        }
        window.confirmSelection = confirmSelection; // 전역 범위로 설정

        function closeTemplatePopup() {
            var popup = document.getElementById('template-popup');
            popup.style.display = 'none';
        }
        window.closeTemplatePopup = closeTemplatePopup; // 전역 범위로 설정

        // 레이아웃 선택 팝업 열기
        function openLayoutPopup() {
            var popup = document.getElementById('layout-popup');
            popup.style.display = 'flex';

            // 팝업 열 때 레이아웃 목록 초기화
            loadLayoutOptions();
        }

        // 레이아웃 선택 팝업 닫기
        function closeLayoutPopup() {
            var popup = document.getElementById('layout-popup');
            popup.style.display = 'none';
        }

        // TAM 팝업 관련 함수들
        function openTAMPopup() {
            var popup = document.getElementById('tam-popup');
            var tamContent = popup.querySelector('.tam-content');
            
            // 서버에서 전달받은 TAM 데이터
            var tamData = {{ generated_sections_TAM | tojson }};
            
            // TAM 데이터가 있는 경우에만 표시
            if (tamData && tamData.TAM && tamData.TAM.text) {
                // 텍스트에서 줄바꿈을 보존하면서 HTML로 변환
                var formattedText = tamData.TAM.text
                    .replace(/\n/g, '<br>')
                    .replace(/\s/g, '&nbsp;');
                    
                tamContent.innerHTML = `
                    <div class="tam-text" style="background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        ${formattedText}
                    </div>
                `;
            } else {
                tamContent.innerHTML = '<p>현재 표시할 수 있는 시장 분석 정보가 없습니다.</p>';
            }
            
            popup.style.display = 'flex';
        }

        function closeTAMPopup() {
            var popup = document.getElementById('tam-popup');
            popup.style.display = 'none';
        }

        // 선택된 레이아웃 번호 저장용 변수
        var selectedLayoutNumber = '';

        // 레이아웃 옵션 로드 (예: 1.pdf, 2.pdf, 3.pdf)
        function loadLayoutOptions() {
            var layoutContainer = document.getElementById('layout-options');
            layoutContainer.innerHTML = ''; // 초기화

            // 예시: 레이아웃 1,2,3 세 가지
            var layouts = [1, 2, 3];

            layouts.forEach(function(num) {
                var container = document.createElement('div');
                container.className = 'template-image-container';
                container.style.width = '200px';
                container.style.height = '280px';
                container.style.border = '1px solid #ccc';
                container.style.display = 'flex';
                container.style.flexDirection = 'column';
                container.style.justifyContent = 'center';
                container.style.alignItems = 'center';
                container.style.padding = '10px';

                // PDF 파일 경로
                var pdfPath = "/static/layout/" + num + ".pdf";

                // 표시용 텍스트 (또는 PDF 썸네일 이미지가 있다면 교체 가능)
                var label = document.createElement('div');
                label.textContent = "레이아웃 " + num;
                label.style.marginBottom = "10px";

                // 간단히 PDF 링크로 열어볼 수 있는 링크 버튼 (옵션)
                var link = document.createElement('a');
                link.href = pdfPath;
                link.target = "_blank";
                link.textContent = "미리보기 (새 탭)";
                link.style.marginBottom = "10px";
                link.style.color = "#007bff";
                link.style.textDecoration = "underline";

                // 선택 표시용 원
                var mark = document.createElement('div');
                mark.className = 'selection-mark';
                mark.style.position = 'relative';
                mark.style.width = '20px';
                mark.style.height = '20px';
                mark.style.border = '2px solid #ccc';
                mark.style.borderRadius = '50%';
                mark.style.cursor = 'pointer';

                container.onclick = function() {
                    selectLayout(num, container);
                };

                container.appendChild(label);
                container.appendChild(link);
                container.appendChild(mark);
                layoutContainer.appendChild(container);
            });
        }

        function selectLayout(num, container) {
            // 이미 선택된 항목 초기화
            var containers = document.querySelectorAll('#layout-options .template-image-container');
            containers.forEach(function(c) {
                c.style.borderColor = '#ccc'; // 초기화
            });

            // 선택된 항목 강조
            container.style.borderColor = '#28a745'; // 녹색 테두리
            selectedLayoutNumber = num;
        }

        function confirmLayoutSelection() {
            if (selectedLayoutNumber === '') {
                alert('레이아웃을 선택해주세요.');
                return;
            }

            // hidden input에 선택된 레이아웃 번호 반영
            var hiddenInput = document.getElementById('selected-layout');
            hiddenInput.value = selectedLayoutNumber;

            // 팝업 닫기
            closeLayoutPopup();
        }

        window.openLayoutPopup = openLayoutPopup;
        window.closeLayoutPopup = closeLayoutPopup;
        window.openTAMPopup = openTAMPopup;
        window.closeTAMPopup = closeTAMPopup;
        window.confirmLayoutSelection = confirmLayoutSelection;
    </script>
</body>
</html>
